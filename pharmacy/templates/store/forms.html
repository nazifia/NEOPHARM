{% extends 'base.html' %}
{% load humanize %}

{% block content %}

<div class="container my-4">
    <!-- Header Section -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h3 class="mb-1">
                        <i class="fas fa-file-medical text-primary me-2"></i>Forms History
                    </h3>
                    <p class="text-muted mb-0">
                        Manage and view all dispensing forms and receipts
                    </p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{% url 'store:dispense' %}" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i> New Dispensing
                    </a>
                    <a href="{% url 'store:cart' %}" class="btn btn-outline-primary">
                        <i class="fas fa-shopping-cart me-1"></i> View Cart
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-3 g-3">
        <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm h-100 border-0 gradient-card-orange">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Total Forms</small>
                            <h4 class="mb-0 fw-bold">{{ forms|length }}</h4>
                        </div>
                        <div class="bg-white bg-opacity-25 p-2 rounded-circle">
                            <i class="fas fa-file-alt fs-4 text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm h-100 border-0 gradient-card-blue">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Total Revenue</small>
                            <h4 class="mb-0 fw-bold">₦{{ total_revenue|floatformat:2|intcomma|default:"0.00" }}</h4>
                        </div>
                        <div class="bg-white bg-opacity-25 p-2 rounded-circle">
                            <i class="fas fa-coins fs-4 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm h-100 border-0 gradient-card-red">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Today's Forms</small>
                            <h4 class="mb-0 fw-bold">{{ today_forms_count }}</h4>
                        </div>
                        <div class="bg-white bg-opacity-25 p-2 rounded-circle">
                            <i class="fas fa-calendar-day fs-4 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm h-100 border-0 gradient-card-green">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">This Month</small>
                            <h4 class="mb-0 fw-bold">₦{{ monthly_total|floatformat:2|intcomma|default:"0.00" }}</h4>
                        </div>
                        <div class="bg-white bg-opacity-25 p-2 rounded-circle">
                            <i class="fas fa-calendar-alt fs-4 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="card shadow-sm mb-3 border-0">
        <div class="card-body p-3">
            <form method="get" class="row g-2 align-items-center">
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" name="q" class="form-control" placeholder="Search Forms, Patient, Hospital No..." value="{{ search_query|default:'' }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <select name="filter" class="form-control form-control-sm" onchange="this.form.submit()">
                        <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All Time</option>
                        <option value="today" {% if filter_type == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if filter_type == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if filter_type == 'month' %}selected{% endif %}>This Month</option>
                    </select>
                </div>
                <div class="col-md-2 text-end ms-auto">
                    <button type="submit" class="btn btn-sm btn-primary w-100">
                        <i class="fas fa-filter me-1"></i> Filter
                    </button>
                </div>
                <div class="col-md-2 text-end ms-auto">
                    <a href="{% url 'store:forms' %}" class="btn btn-sm btn-outline-secondary w-100">
                        <i class="fas fa-undo me-1"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Forms Table Section -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom-0 py-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0 fw-bold"><i class="fas fa-list me-2 text-primary"></i>Forms List</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <span class="badge bg-light text-dark border px-3 py-2" style="font-size: 0.8rem;">
                        <i class="fas fa-info-circle me-1"></i>Showing {{ forms|length }} forms
                    </span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if forms %}
            <div class="table-responsive mb-0">
                <table class="table table-hover mb-0" style="font-size: 0.9rem;">
                    <thead class="table-light">
                        <tr class="text-muted text-uppercase small fw-bold" style="font-size: 0.75rem;">
                            <th style="width: 15%;">Form ID</th>
                            <th style="width: 22%;">Patient</th>
                            <th style="width: 15%;">Hospital No</th>
                            <th style="width: 20%;">Date & Time</th>
                            <th style="width: 12%; text-align: right;">Amount</th>
                            <th style="width: 16%; text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in forms %}
                        <tr class="align-middle {% if forloop.counter0 < 3 %}table-primary{% endif %}">
                            <td class="fw-semibold text-primary">{{ form.form_id }}
                                {% if forloop.counter0 < 3 %}
                                <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6rem;">LATEST</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="fw-semibold">{{ form.buyer_name }}</div>
                                {% if form.ncap_no %}
                                <small class="text-muted"><i class="fas fa-tag text-warning me-1"></i>NCAP: {{ form.ncap_no }}</small>
                                {% endif %}
                            </td>
                            <td><code class="text-dark">{{ form.hospital_no }}</code></td>
                            <td class="text-muted">{{ form.date|date:"M d, Y" }}<br><small>{{ form.date|date:"h:i A" }}</small></td>
                            <td class="text-end fw-bold text-success fs-6">₦{{ form.total_amount|floatformat:2|intcomma }}</td>
                            <td class="text-end">
                                <div class="btn-group" role="group">
                                    <a href="{% url 'store:view_form' form.form_id %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'store:view_form' form.form_id %}" class="btn btn-sm btn-outline-secondary" title="Print" onclick="event.preventDefault(); popupCenter('{% url 'store:view_form' form.form_id %}', 'form_{{ form.form_id }}', 800, 900); return false;">
                                        <i class="fas fa-print"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-file-medical-alt text-muted fs-1"></i>
                <h5 class="mt-2 text-muted">No forms found</h5>
                <p class="text-muted small">Get started by creating a new dispensing form from the cart.</p>
                <a href="{% url 'store:cart' %}" class="btn btn-primary btn-sm mt-2">
                    <i class="fas fa-shopping-cart me-1"></i> Go to Cart
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="row mt-3">
        <div class="col-lg-8 mb-2 mb-lg-0">
            <div class="card shadow-sm border-0 h-100 gradient-card-light">
                <div class="card-body p-3">
                    <h6 class="fw-bold mb-3"><i class="fas fa-bolt me-2 text-warning"></i>Quick Actions</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{% url 'store:dispense' %}" class="btn btn-success btn-sm">
                            <i class="fas fa-pills me-1"></i> Add New Dispensing
                        </a>
                        <a href="{% url 'store:store' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-store me-1"></i> Browse Store
                        </a>
                        <a href="{% url 'store:cart' %}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-shopping-cart me-1"></i> View Cart ({{ cart_count|default:0 }})
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100 gradient-card-purple">
                <div class="card-body p-3">
                    <h6 class="fw-bold mb-2"><i class="fas fa-info-circle me-2 text-purple"></i>Helpful Info</h6>
                    <ul class="list-unstyled small text-muted mb-0">
                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Click View button to see form details</li>
                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Print receipts for verified dispensings</li>
                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>Latest forms marked with yellow badge</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Enhanced print/popup function for form viewing
    function popupCenter(url, title, w, h) {
        const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : window.screenX;
        const dualScreenTop = window.screenTop !== undefined ? window.screenTop : window.screenY;
        const width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
        const height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;
        const systemZoom = width / window.screen.availWidth;
        const left = (width - w) / 2 / systemZoom + dualScreenLeft;
        const top = (height - h) / 2 / systemZoom + dualScreenTop;
        const newWindow = window.open(url, title, `scrollbars=yes, width=${w / systemZoom}, height=${h / systemZoom}, top=${top}, left=${left}`);
        if (window.focus) newWindow.focus();
    }

    // Enhanced form search functionality with debounce
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('input[name="q"]');
        if (searchInput) {
            let debounceTimer;
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    if (this.value.length >= 2 || this.value.length === 0) {
                        this.closest('form').submit();
                    }
                }, 500);
            });
        }
    });
</script>
{% endblock %}

<style>
    /* Gradient Cards Styling for Stats */
    .gradient-card-orange {
        background: linear-gradient(135deg, #FFF5EB 0%, #FFE4D6 100%);
        border-left: 4px solid #FB8C00;
    }
    
    .gradient-card-blue {
        background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
        border-left: 4px solid #1976D2;
    }
    
    .gradient-card-red {
        background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
        border-left: 4px solid #D32F2F;
    }
    
    .gradient-card-green {
        background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
        border-left: 4px solid #388E3C;
    }
    
    .gradient-card-purple {
        background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
        border-left: 4px solid #7B1FA2;
    }
    
    .gradient-card-light {
        background: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%);
        border-left: 4px solid #757575;
    }
    
    .text-purple {
        color: #7B1FA2;
    }
    
    /* Enhanced table styling */
    .table-hover tbody tr.table-primary:hover {
        background-color: #E3F2FD !important;
    }
    
    .table-primary {
        background-color: #E3F2FD !important;
    }
    
    /* Enhanced badge styling */
    .badge {
        font-weight: 600;
        letter-spacing: 0.3px;
    }
    
    /* Button group shadow on hover */
    .btn-group .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    
    /* Code styling for hospital number */
    code {
        font-family: 'Courier New', monospace;
        background-color: #F8F9FA;
        padding: 2px 6px;
        border-radius: 3px;
        border: 1px solid #DEE2E6;
        font-size: 0.85rem;
    }
    
    /* Enhanced input focus states */
    .form-control:focus, .form-select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25);
    }
    
    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .table {
            font-size: 0.85rem;
        }
        
        .btn-group .btn {
            padding: 0.25rem 0.5rem;
        }
        
        .stat-card {
            font-size: 0.9rem;
        }
    }
    
    @media (max-width: 767.98px) {
        .d-flex.align-items-center.gap-2 {
            flex-wrap: wrap;
        }

        .d-flex.align-items-center.gap-2 strong {
            width: 100%;
            margin-bottom: 0.25rem;
        }
    }

    @media print {
        .btn, .navbar, footer, .search-section, .quick-actions-section,
        .helpful-info-section, .gradient-card {
            display: none !important;
        }
        
        /* Hide specific elements that shouldn't print */
        .col-md-3, .col-md-2, .col-lg-4, .col-lg-8,
        .row.g-3, .row.g-2, .form-control, .form-select,
        .input-group, .btn-sm, .btn-group, .d-flex.gap-2,
        .d-flex.gap-3, .gradient-card {
            display: none !important;
        }
        
        .card {
            border: none !important;
            box-shadow: none !important;
            background: #fff !important;
        }
        
        .card-header {
            background-color: #fff !important;
            color: #000 !important;
            border-bottom: 2px solid #000 !important;
        }
        
        .badge {
            border: 1px solid #666 !important;
            color: #000 !important;
            background-color: transparent !important;
        }
        
        /* Ensure table colors are print-friendly */
        .table th {
            background-color: #f0f0f0 !important;
            color: #000 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .table td,
        .table th {
            border: 1px solid #333 !important;
            color: #000 !important;
        }
        
        /* Only show specific cards in print - primarily the table */
        .container > .row:not(:first-child),
        .container > .card:not(:nth-of-type(3)) {
            display: none !important;
        }
        
        /* Optimize for printing */
        body {
            margin: 0 !important;
            padding: 0 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .container {
            padding: 0 10px !important;
            max-width: 100% !important;
        }
        
        .table-responsive {
            overflow: visible !important;
        }
    }
</style>